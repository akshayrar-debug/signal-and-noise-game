<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator - Signal & Noise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .case-file-card { background-color: #fdfd96; border-left: 5px solid #f0e68c; }
        .ai-response { background-color: #e0f2fe; }
        .team-question { background-color: #d1fae5; }
        .model-answer { background-color: #e9d5ff; border-left: 4px solid #8b5cf6; }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #detailed-scoreboard-page { transition: opacity 0.3s ease-in-out; }
        .joker-active-btn {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 10px 10px rgba(34, 197, 94, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Signal & Noise <span class="text-blue-600">(Moderator)</span></h1>
        </header>

        <div id="moderator-controls" class="bg-white p-4 rounded-lg shadow-md mb-8 relative">
            <h2 class="text-xl font-semibold mb-4 text-center">Moderator Panel</h2>
            <div class="flex flex-wrap justify-center items-center gap-4">
                 <p id="case-file-status" class="text-gray-600">Click "Start New Round" to begin.</p>
                <button id="start-round-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Start New Round</button>
                <button id="end-round-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 hidden">End Round</button>
            </div>
            <button id="scoreboard-icon" class="absolute top-4 right-4 text-gray-500 hover:text-blue-600">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </button>
        </div>

        <main class="grid grid-cols-1 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="round-title" class="text-2xl font-bold">Round <span id="round-number">1</span></h2>
                    <div id="timer" class="text-3xl font-bold text-gray-400">10:00</div>
                </div>
                
                <div id="game-area">
                    <div id="prep-phase-display" class="text-center p-4 mb-4 bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg hidden">
                        <h3 class="text-lg font-semibold text-blue-800">Preparation Phase</h3>
                        <p class="text-blue-700">Teams are reviewing the case and activating Jokers.</p>
                        <div id="prep-timer" class="text-4xl font-bold text-blue-600 mt-2">00:30</div>
                        <div id="joker-status-display" class="mt-4 text-sm text-gray-600"></div>
                    </div>

                    <div id="case-file-display" class="p-4 rounded-lg mb-6 case-file-card hidden">
                        <h3 id="case-file-title" class="font-bold text-lg mb-2">Case File</h3>
                        <p id="case-file-text" class="text-gray-700 whitespace-pre-wrap"></p>
                    </div>

                    <div id="interaction-area" class="hidden">
                        <div id="chat-box" class="h-96 overflow-y-auto border rounded-lg p-4 mb-4 bg-gray-50"></div>
                        <div class="flex items-center gap-4">
                             <select id="team-ask-select" class="p-2 border rounded-md bg-gray-50 flex-shrink-0"></select>
                            <input type="text" id="question-input" class="flex-grow p-2 border rounded-md" placeholder="Ask a question on behalf of a team...">
                            <button id="ask-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Ask</button>
                        </div>
                    </div>
                    
                    <div id="solution-area" class="mt-4 text-center hidden">
                         <button id="solution-btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Reveal 10/10 Answer</button>
                    </div>

                     <div id="start-prompt" class="text-center py-16">
                        <p class="text-xl text-gray-500">Click "Start New Round" to begin.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Detailed Scoreboard Page -->
    <div id="detailed-scoreboard-page" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-3xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Full Scoreboard</h2>
                <button id="close-scoreboard-btn" class="text-gray-500 hover:text-red-600">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="detailed-scoreboard-content" class="space-y-2"></div>
        </div>
    </div>
    
    <script>
        // Central Game State
        let gameState = {
            round: 0,
            teams: [],
            currentCaseFile: null,
            prepTimerInterval: null,
            mainTimerInterval: null,
            prepTimeLeft: 30,
            mainTimeLeft: 600,
            gameActive: false,
            prepActive: false,
            chatHistory: [],
            solutionVisible: false,
            tenTenAnswer: ''
        };

        // DOM Elements
        const caseFileStatus = document.getElementById('case-file-status');
        const startRoundBtn = document.getElementById('start-round-btn');
        const endRoundBtn = document.getElementById('end-round-btn');
        const roundNumberEl = document.getElementById('round-number');
        const timerEl = document.getElementById('timer');
        const caseFileDisplay = document.getElementById('case-file-display');
        const caseFileTitle = document.getElementById('case-file-title');
        const caseFileText = document.getElementById('case-file-text');
        const interactionArea = document.getElementById('interaction-area');
        const startPrompt = document.getElementById('start-prompt');
        const chatBox = document.getElementById('chat-box');
        const questionInput = document.getElementById('question-input');
        const askBtn = document.getElementById('ask-btn');
        const teamAskSelect = document.getElementById('team-ask-select');
        const scoreboardIcon = document.getElementById('scoreboard-icon');
        const detailedScoreboardPage = document.getElementById('detailed-scoreboard-page');
        const closeScoreboardBtn = document.getElementById('close-scoreboard-btn');
        const detailedScoreboardContent = document.getElementById('detailed-scoreboard-content');
        const solutionArea = document.getElementById('solution-area');
        const solutionBtn = document.getElementById('solution-btn');
        const prepPhaseDisplay = document.getElementById('prep-phase-display');
        const prepTimerEl = document.getElementById('prep-timer');
        const jokerStatusDisplay = document.getElementById('joker-status-display');

        function initializeGame() {
            localStorage.removeItem('signalNoiseGameState');
            for (let i = 1; i <= 5; i++) {
                gameState.teams.push({ id: i, name: `Team ${i}`, score: 0, jokerAvailable: true, swapsAvailable: 1, jokerActive: false });
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Team ${i}`;
                teamAskSelect.appendChild(option);
            }
            updateLocalStorage();
        }

        function updateLocalStorage() {
            localStorage.setItem('signalNoiseGameState', JSON.stringify(gameState));
        }

        async function startNewRound() {
            if (startRoundBtn.disabled) return;
            clearInterval(gameState.prepTimerInterval);
            clearInterval(gameState.mainTimerInterval);
            
            startRoundBtn.disabled = true;
            caseFileStatus.innerHTML = '<div class="flex items-center justify-center"><div class="spinner w-5 h-5 mr-2"></div>Generating...</div>';
            
            const newCaseFile = await generateNewCaseFile();
            if (!newCaseFile) {
                alert("Failed to generate a new case file. Please try again.");
                startRoundBtn.disabled = false;
                caseFileStatus.textContent = "Error. Try again.";
                return;
            }
            
            gameState.round++;
            gameState.currentCaseFile = newCaseFile;
            gameState.chatHistory = [];
            gameState.solutionVisible = false;
            gameState.tenTenAnswer = '';
            gameState.teams.forEach(t => t.jokerActive = false);
            
            roundNumberEl.textContent = gameState.round;
            caseFileTitle.textContent = gameState.currentCaseFile.title;
            caseFileText.textContent = gameState.currentCaseFile.noise;
            
            startPreparationPhase();
        }

        function startPreparationPhase() {
            gameState.prepActive = true;
            gameState.gameActive = false;
            
            startPrompt.classList.add('hidden');
            caseFileDisplay.classList.remove('hidden');
            interactionArea.classList.add('hidden');
            solutionArea.classList.add('hidden');
            startRoundBtn.classList.add('hidden');
            endRoundBtn.classList.add('hidden');
            prepPhaseDisplay.classList.remove('hidden');
            
            timerEl.classList.add('text-gray-400');
            timerEl.textContent = "10:00";

            gameState.prepTimeLeft = 30;
            updatePrepTimer();
            gameState.prepTimerInterval = setInterval(updatePrepTimer, 1000);
            caseFileStatus.textContent = "Preparation Phase...";
            updateLocalStorage();
        }

        function updatePrepTimer() {
            gameState.prepTimeLeft--;
            prepTimerEl.textContent = `00:${gameState.prepTimeLeft.toString().padStart(2, '0')}`;
            
            const storedState = JSON.parse(localStorage.getItem('signalNoiseGameState'));
            if (storedState) {
                gameState.teams = storedState.teams;
                const activeJokers = gameState.teams.filter(t => t.jokerActive).map(t => t.name).join(', ');
                jokerStatusDisplay.textContent = activeJokers ? `Jokers Active: ${activeJokers}` : 'No Jokers Active';
            }

            if (gameState.prepTimeLeft <= 0) {
                clearInterval(gameState.prepTimerInterval);
                startMainRound();
            }
        }

        function startMainRound() {
            gameState.prepActive = false;
            gameState.gameActive = true;

            prepPhaseDisplay.classList.add('hidden');
            interactionArea.classList.remove('hidden');
            endRoundBtn.classList.remove('hidden');
            
            timerEl.classList.remove('text-gray-400');
            
            gameState.mainTimeLeft = 600;
            updateMainTimer();
            gameState.mainTimerInterval = setInterval(updateMainTimer, 1000);
            caseFileStatus.textContent = "Round in progress...";
            
            updateLocalStorage();
            renderChat();
        }

        function updateMainTimer() {
            gameState.mainTimeLeft--;
            const minutes = Math.floor(gameState.mainTimeLeft / 60);
            const seconds = gameState.mainTimeLeft % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (gameState.mainTimeLeft <= 0) {
                endRound();
            }
            updateLocalStorage();
        }

        function endRound() {
            clearInterval(gameState.mainTimerInterval);
            gameState.gameActive = false;
            endRoundBtn.classList.add('hidden');
            startRoundBtn.classList.remove('hidden');
            startRoundBtn.disabled = false;
            solutionArea.classList.remove('hidden');
            caseFileStatus.textContent = "Round ended. Awaiting diagnoses.";
            updateLocalStorage(); 
        }

        async function handleAskQuestion() {
            const teamId = parseInt(teamAskSelect.value);
            const team = gameState.teams.find(t => t.id === teamId);
            const question = questionInput.value.trim();

            if (!question || !team || !gameState.gameActive) return;

            gameState.chatHistory.push({ author: team.name, text: question, type: 'team-question' });
            renderChat();
            
            questionInput.value = '';
            questionInput.disabled = true;
            askBtn.disabled = true;

            const aiResponse = await getAIResponse(question);
            gameState.chatHistory.push({ author: 'AI', text: aiResponse, type: 'ai-response' });
            
            questionInput.disabled = false;
            askBtn.disabled = false;
            questionInput.focus();
            
            renderChat();
            updateLocalStorage();
        }
        
        function renderChat() {
            chatBox.innerHTML = '';
            gameState.chatHistory.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `p-3 rounded-lg mb-2 ${msg.type}`;
                messageEl.innerHTML = `<p><span class="font-bold">${msg.author}:</span> ${msg.text}</p>`;
                chatBox.appendChild(messageEl);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function revealSolution() {
            if (gameState.tenTenAnswer) {
                gameState.solutionVisible = true;
                updateLocalStorage();
                return;
            }
            
            solutionBtn.textContent = 'Generating...';
            solutionBtn.disabled = true;
            
            const modelAnswer = await getAIModelAnswer();
            gameState.tenTenAnswer = modelAnswer;
            gameState.solutionVisible = true;
            
            solutionBtn.textContent = 'Reveal 10/10 Answer';
            solutionBtn.disabled = false;
            
            updateLocalStorage();
        }

        function showDetailedScoreboard() {
            const storedState = JSON.parse(localStorage.getItem('signalNoiseGameState'));
            if (!storedState) return;

            detailedScoreboardContent.innerHTML = `
                <div class="grid grid-cols-3 gap-4 text-center font-bold border-b pb-2 mb-2 text-gray-600">
                    <span>Team</span>
                    <span>Score</span>
                    <span>Jokers Left</span>
                </div>
            `;
            const sortedTeams = [...storedState.teams].sort((a, b) => b.score - a.score);
            sortedTeams.forEach(team => {
                const row = document.createElement('div');
                row.className = `grid grid-cols-3 gap-4 text-center p-2 rounded-md hover:bg-gray-100 items-center`;
                row.innerHTML = `
                    <span class="font-semibold text-left">${team.name}</span>
                    <span class="font-bold text-xl">${team.score}</span>
                    <span>${team.jokerAvailable ? '1' : '0'}</span>
                `;
                detailedScoreboardContent.appendChild(row);
            });

            detailedScoreboardPage.classList.remove('hidden');
            setTimeout(() => detailedScoreboardPage.classList.remove('opacity-0'), 10);
        }

        function hideDetailedScoreboard() {
            detailedScoreboardPage.classList.add('opacity-0');
            setTimeout(() => detailedScoreboardPage.classList.add('hidden'), 300);
        }

        async function makeApiCall(prompt, schema) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            
            let attempt = 0;
            const maxAttempts = 3;
            let delay = 1000;

            while (attempt < maxAttempts) {
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        if (response.status >= 400 && response.status < 500) {
                            console.error("API client error:", await response.text());
                            throw new Error(`API request failed with status ${response.status}`);
                        }
                        throw new Error(`API server error with status ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Invalid API response structure");
                    }
                    return JSON.parse(result.candidates[0].content.parts[0].text);

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    attempt++;
                    if (attempt >= maxAttempts) {
                        console.error("All API call attempts failed.");
                        return null;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            return null;
        }

        async function generateNewCaseFile() {
             const topics = ["SaaS Platform", "E-commerce Website", "Internal IT Project", "Healthcare Software"];
             const roles = ["Customer Success Manager", "Project Manager"];
             const randomTopic = topics[Math.floor(Math.random() * topics.length)];
             const randomRole = roles[Math.floor(Math.random() * roles.length)];
             const generationPrompt = `Generate a new, unique case file for a business simulation game. The theme is: ${randomTopic} for a ${randomRole}. The JSON object must have "title", "noise", and "signal" properties. "signal" must contain "rootCause" and "goal".`;
            const schema = { type: "OBJECT", properties: { "title": { "type": "STRING" }, "noise": { "type": "STRING" }, "signal": { "type": "OBJECT", "properties": { "rootCause": { "type": "STRING" }, "goal": { "type": "STRING" }}}} };
            return makeApiCall(generationPrompt, schema);
        }

        async function getAIResponse(question) {
            const { noise, signal } = gameState.currentCaseFile;
            const prompt = `You are a role-playing AI. Respond realistically to the user's question based on the scenario. Do not reveal the secret info. Give helpful "Signal" info only for good, specific questions. Give vague "Noise" responses for bad questions.
            SCENARIO: ${noise}
            SECRET INFO: Root cause is "${signal.rootCause}". Real goal is "${signal.goal}".
            USER'S QUESTION: "${question}"
            Return only the role-played response as a single string.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) { console.error("Error getting AI response:", error); return "I'm having trouble with that request."; }
        }
        
        async function getAIModelAnswer() {
            const { noise, signal } = gameState.currentCaseFile;
            const prompt = `You are an expert consultant. Based on the case file, provide a brief summary of a perfect "10/10" diagnosis. Explain the ideal thought process, key questions, and final conclusion.
            INITIAL COMPLAINT: ${noise}
            REAL SITUATION: Root cause is "${signal.rootCause}". Real goal is "${signal.goal}".
            Return a single string with your summary.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) { console.error("Error getting model answer:", error); return "Could not retrieve model answer."; }
        }

        // Event Listeners
        startRoundBtn.addEventListener('click', startNewRound);
        endRoundBtn.addEventListener('click', endRound);
        askBtn.addEventListener('click', handleAskQuestion);
        solutionBtn.addEventListener('click', revealSolution);
        questionInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleAskQuestion(); });
        scoreboardIcon.addEventListener('click', showDetailedScoreboard);
        closeScoreboardBtn.addEventListener('click', hideDetailedScoreboard);
        
        window.addEventListener('storage', (event) => {
            if (event.key === 'signalNoiseGameState' && gameState.prepActive) {
                const storedState = JSON.parse(event.newValue);
                if (storedState) {
                    gameState.teams = storedState.teams;
                    const activeJokers = gameState.teams.filter(t => t.jokerActive).map(t => t.name).join(', ');
                    jokerStatusDisplay.textContent = activeJokers ? `Jokers Active: ${activeJokers}` : 'No Jokers Active';
                }
            }
        });

        initializeGame();
    </script>
</body>
</html>
