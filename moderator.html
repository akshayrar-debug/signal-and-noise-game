<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator - Signal & Noise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .case-file-card { background-color: #fdfd96; border-left: 5px solid #f0e68c; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Signal & Noise <span class="text-blue-600">(Moderator)</span></h1>
        </header>

        <div id="moderator-controls" class="bg-white p-4 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-center">Moderator Panel</h2>
            <div class="flex flex-wrap justify-center items-center gap-4">
                 <p id="case-file-status" class="text-gray-600">Click "Start New Round" to begin.</p>
                <button id="start-round-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Start New Round</button>
            </div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="round-title" class="text-2xl font-bold">Round <span id="round-number">1</span></h2>
                    <div id="timer" class="text-3xl font-bold text-gray-400">10:00</div>
                </div>
                
                <div id="game-area">
                    <div id="prep-phase-display" class="text-center p-4 mb-4 bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg hidden">
                        <h3 class="text-lg font-semibold text-blue-800">Preparation Phase</h3>
                        <p class="text-blue-700">Teams are reviewing the case and activating Jokers.</p>
                        <div id="prep-timer" class="text-4xl font-bold text-blue-600 mt-2">00:30</div>
                    </div>

                     <div id="case-file-display" class="p-4 rounded-lg mb-6 case-file-card hidden">
                        <h3 id="case-file-title" class="font-bold text-lg mb-2">Case File</h3>
                        <p id="case-file-text" class="text-gray-700 whitespace-pre-wrap"></p>
                    </div>
                     <div id="start-prompt" class="text-center py-16">
                        <p class="text-xl text-gray-500">Click "Start New Round" to begin.</p>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Team Status</h2>
                <div id="team-status-display" class="space-y-4">
                </div>
            </div>
        </main>
    </div>
    
    <script>
        let gameState = {
            round: 0,
            teams: [],
            currentCaseFile: null,
            prepTimerInterval: null,
            mainTimerInterval: null,
            prepTimeLeft: 30,
            mainTimeLeft: 600,
            gameActive: false,
            prepActive: false,
        };

        const staticCaseFiles = [
            {
                title: "The Frustrated User",
                noise: `You get an email from Tom, a new user at a key account.\n\nSubject: Your software is impossible!\n\n"I'm trying to do my job and your platform is just not user-friendly. I spent an hour trying to get a simple task done and got nowhere. I don't have time for this. My boss told me we have to use this, but I'm ready to go back to my old spreadsheets."`,
                signal: {
                    rootCause: "The user is trying to use the 'Bulk Data Import' feature but doesn't have the correct admin permissions enabled for his user role.",
                    goal: "He needs to import a list of 500 new leads from a CSV file to start his weekly outreach campaign."
                }
            },
            {
                title: "The Last-Minute Change",
                noise: `You get a call from Susan, the Head of Marketing, about the new landing page project that's due to launch next week.\n\nVoicemail: "Hi, quick one. I just saw the final design and the main banner needs to be video, not a static image. It's a must-have for the campaign. It should be an easy change, just swap the file. Let's get it done before the launch. Thanks!"`,
                signal: {
                    rootCause: "Susan saw a competitor's new website that uses video and is having a reactive moment, fearing the new landing page will look dated on launch.",
                    goal: "She wants to ensure the new landing page has a high-impact, modern feel that will capture visitor attention immediately and increase the 'time on page' metric for her campaign."
                }
            },
            {
                title: "The Data Discrepancy",
                noise: `A support ticket is escalated to you from a high-value client.\n\nSubject: Numbers don't match! URGENT!\n\n"The monthly user engagement report from your dashboard shows 1,500 active users. Our internal analytics tool shows only 1,200. This is a huge discrepancy. We can't trust your data, and we need to report on this to our leadership by EOD."`,
                signal: {
                    rootCause: "Your platform defines an 'active user' as anyone who logs in. Their internal tool defines it as someone who performs a 'key action' (e.g., creates a report). The definitions are different.",
                    goal: "They need a reliable, agreed-upon number of users who are *truly engaging* with the platform to justify the software's cost to their leadership."
                }
            },
            {
                title: "The Integration Request",
                noise: `An executive stakeholder, David, sends you a message about your team's current project.\n\nMessage: "We need to integrate our new CRM, 'ConnectSphere,' into the platform. It's our new company-wide standard. All customer data needs to sync with it. This is a top priority from the leadership team."`,
                signal: {
                    rootCause: "The sales team currently has to manually copy-paste customer contact information from your platform into the new CRM after every client call, which is slow and causes errors.",
                    goal: "To automatically sync only the customer's Name, Email, and Phone Number from your platform to ConnectSphere to save the sales team time and improve data accuracy."
                }
            },
            {
                title: "The Performance Problem",
                noise: `You receive an email from a long-time power user.\n\nSubject: Everything is so slow...\n\n"Lately, the whole platform just feels sluggish. It takes forever for pages to load, especially in the morning. It used to be so fast. Is something wrong on your end? It's really impacting my team's productivity."`,
                signal: {
                    rootCause: "The user's team has accumulated over 50,000 archived records in their shared dashboard view. The system is slow because it's trying to load all of them by default every time they log in.",
                    goal: "The team needs a way to set their default dashboard view to show only 'Active' records from the last 30 days, so the page loads quickly and they can get to their daily tasks efficiently."
                }
            }
        ];

        const caseFileStatus = document.getElementById('case-file-status');
        const startRoundBtn = document.getElementById('start-round-btn');
        const roundNumberEl = document.getElementById('round-number');
        const timerEl = document.getElementById('timer');
        const caseFileDisplay = document.getElementById('case-file-display');
        const caseFileTitle = document.getElementById('case-file-title');
        const caseFileText = document.getElementById('case-file-text');
        const startPrompt = document.getElementById('start-prompt');
        const prepPhaseDisplay = document.getElementById('prep-phase-display');
        const prepTimerEl = document.getElementById('prep-timer');
        const teamStatusDisplay = document.getElementById('team-status-display');

        function initializeGame() {
            localStorage.clear();
            for (let i = 1; i <= 5; i++) {
                gameState.teams.push({ id: i, name: `Team ${i}`, score: 0, jokerAvailable: true, jokerActive: false, diagnosis: { rootCause: '', goal: '' }, hasSubmitted: false });
            }
            updateLocalStorage();
            renderTeamStatus();
        }

        function updateLocalStorage() {
            localStorage.setItem('signalNoiseGameState', JSON.stringify(gameState));
        }

        function startNewRound() {
            clearInterval(gameState.prepTimerInterval);
            clearInterval(gameState.mainTimerInterval);
            
            const newCaseFile = staticCaseFiles[gameState.round % staticCaseFiles.length];
            
            gameState.round++;
            gameState.currentCaseFile = newCaseFile;
            gameState.teams.forEach(t => {
                t.jokerActive = false;
                t.diagnosis = { rootCause: '', goal: '' };
                t.hasSubmitted = false;
            });
            
            roundNumberEl.textContent = gameState.round;
            caseFileTitle.textContent = newCaseFile.title;
            caseFileText.textContent = newCaseFile.noise;
            
            startPreparationPhase();
        }

        function startPreparationPhase() {
            gameState.prepActive = true;
            gameState.gameActive = false;
            
            startPrompt.classList.add('hidden');
            caseFileDisplay.classList.remove('hidden');
            startRoundBtn.classList.add('hidden');
            prepPhaseDisplay.classList.remove('hidden');
            
            timerEl.classList.add('text-gray-400');
            timerEl.textContent = "10:00";

            gameState.prepTimeLeft = 30;
            updatePrepTimer();
            gameState.prepTimerInterval = setInterval(updatePrepTimer, 1000);
            caseFileStatus.textContent = "Preparation Phase...";
            updateLocalStorage();
        }

        function updatePrepTimer() {
            gameState.prepTimeLeft--;
            prepTimerEl.textContent = `00:${gameState.prepTimeLeft.toString().padStart(2, '0')}`;
            
            const storedState = JSON.parse(localStorage.getItem('signalNoiseGameState'));
            if (storedState) {
                gameState.teams = storedState.teams;
                renderTeamStatus();
            }

            if (gameState.prepTimeLeft <= 0) {
                clearInterval(gameState.prepTimerInterval);
                startMainRound();
            }
        }

        function startMainRound() {
            gameState.prepActive = false;
            gameState.gameActive = true;

            prepPhaseDisplay.classList.add('hidden');
            
            timerEl.classList.remove('text-gray-400');
            
            gameState.mainTimeLeft = 600;
            updateMainTimer();
            gameState.mainTimerInterval = setInterval(updateMainTimer, 1000);
            caseFileStatus.textContent = "Round in progress...";
            
            updateLocalStorage();
        }

        function updateMainTimer() {
            gameState.mainTimeLeft--;
            const minutes = Math.floor(gameState.mainTimeLeft / 60);
            const seconds = gameState.mainTimeLeft % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const storedState = JSON.parse(localStorage.getItem('signalNoiseGameState'));
             if (storedState) {
                gameState.teams = storedState.teams;
                renderTeamStatus();
                const allSubmitted = gameState.teams.every(t => t.hasSubmitted);
                if (allSubmitted) {
                    endRound();
                }
            }

            if (gameState.mainTimeLeft <= 0) {
                endRound();
            }
            updateLocalStorage();
        }

        function endRound() {
            clearInterval(gameState.mainTimerInterval);
            gameState.gameActive = false;
            startRoundBtn.classList.remove('hidden');
            caseFileStatus.textContent = "Round ended. Calculating scores...";
            scoreRound();
            updateLocalStorage(); 
        }

        function renderTeamStatus() {
            teamStatusDisplay.innerHTML = '';
            gameState.teams.forEach(team => {
                const teamDiv = document.createElement('div');
                const hasSubmitted = team.hasSubmitted;
                teamDiv.className = `p-4 border rounded-lg ${hasSubmitted ? 'bg-green-100 border-green-300' : 'bg-gray-50'}`;
                teamDiv.innerHTML = `
                    <h4 class="font-bold text-lg flex justify-between items-center">
                        <span>${team.name}</span>
                        <span class="text-sm font-medium ${hasSubmitted ? 'text-green-600' : 'text-gray-500'}">${hasSubmitted ? 'Submitted' : 'Pending'}</span>
                    </h4>
                    <p class="text-sm mt-1 ${team.jokerActive ? 'text-yellow-600 font-semibold' : 'text-gray-400'}">
                        ${team.jokerActive ? 'Joker Active' : 'No Joker'}
                    </p>
                `;
                teamStatusDisplay.appendChild(teamDiv);
            });
        }

        async function scoreRound() {
            const storedState = JSON.parse(localStorage.getItem('signalNoiseGameState'));
            if (storedState) gameState.teams = storedState.teams;

            let roundScores = [];

            for (const team of gameState.teams) {
                const { rootCause, goal } = team.diagnosis;
                let finalPoints = 0;
                if (rootCause || goal) {
                    const finalScore = await makeApiCall('scoreDiagnosis', {
                        signal: gameState.currentCaseFile.signal,
                        submittedRootCause: rootCause,
                        submittedGoal: goal
                    });
                    if (finalScore.correctRootCause) finalPoints += 10;
                    if (finalScore.correctGoal) finalPoints += 10;
                }
                
                if (team.jokerActive) {
                    finalPoints += 20; // Joker bonus
                    team.jokerAvailable = false;
                }
                
                team.score += finalPoints;
                roundScores.push({ teamId: team.id, score: finalPoints });
            }
            
            alert("Scores calculated! Check the team room for results.");
            updateLocalStorage();
        }
        
        async function makeApiCall(action, payload) {
            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload })
                });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("API Call Error:", error);
                return null;
            }
        }

        window.addEventListener('storage', (event) => {
            if (event.key === 'signalNoiseGameState') {
                const storedState = JSON.parse(event.newValue);
                if (storedState) {
                    gameState = storedState;
                    renderTeamStatus();
                }
            }
        });

        initializeGame();
    </script>
</body>
</html>
